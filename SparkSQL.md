# coin-trader
---
title: SparkSQL
description: Dune is sunsetting SparkSQL. Support for SparkSQL will be removed on 2023-07-31. Please migrate your queries to DuneSQL.
---

!!! warning "Warning"

    Dune is sunsetting SparkSQL. Support for SparkSQL will be removed on **30/07/2023**. Please migrate your queries to DuneSQL.

## SparkSQL

SparkSQL is a query engine that is based on Apache Spark.  
This Query engine already runs on our V2 database, so the data you can query is the same as with DuneSQL.  
Unfortunately SparkSQL is not a good fit for our use case and therefore we are deprecating it.

SparkSQL is still in production and will be supported until **30/07/2023**. After that date, SparkSQL will be removed from production and all queries need to be migrated to DuneSQL.

You can read more about SparkSQL in the [SparkSQL documentation](https://spark.apache.org/docs/latest/sql-ref.html).

### Migrating from SparkSQL

Migrating queries from SparkSQL to DuneSQL is somewhat easy. The two query engines query the same data and therefore the queries are very similar.

| **Description**                                                                       | **V2 - Spark SQL**                                                                        | **V2 - Dune SQL**                                                                                                                                                                                                                                                                                           |
|---------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **`bytea2numeric`, or casting hex/bytea to a number**                                 | `bytea2numeric_v3` (string)                                                               | `bytearray_to_integer` (hex)   `bytearray_to_bigint` (hex)   `bytearray_to_decimal` (hex)   `bytearray_to_uint256` (hex)   `bytearray_to_int256` (hex)   More details on [Byte Array to Numeric Functions](#byte-array-to-numeric-functions)                                                                |
| **Doing math or numeric operations on a column, like value in ethereum.transactions** | sum(value)                                                                                | sum(cast(value as double)) *soon this won't be needed as UINT and INT columns are added automatically.*                                                                                                                                                                                                     |
| **0 vs 1 array based indexing**                                                       | 0 indexed                                                                                 | 1 indexed                                                                                                                                                                                                                                                                                                   |
| **Implicit type conversions between character and numeric types**                     | Available                                                                                 | [Not available](https://trino.io/docs/current/functions/conversion.html)                                                                                                                                                                                                                                    |
| **Addresses**                                                                         | `0x2a7d...` (string)  Has to be lowercase in Spark.  Can be done via `lower('0x2A7D...')` | `0x2a7d...` (Byte array)    No escape quotes should be used, and the literal does __not__ need to be lowercased.                                                                                                                                                                                            |
| **Selecting keyword columns is different**                                            | \`from\`                                                                                  | "from"                                                                                                                                                                                                                                                                                                      |
| **Alias naming is different**                                                         | as \`daily active user\`                                                                  | as "daily active users"                                                                                                                                                                                                                                                                                     |
| **Exponentiation notation**                                                           | `x*power(10,y)` or `x*1e123`                                                              | `x*power(10,y)` or `x * 1e123`                                                                                                                                                                                                                                                                              |
| **Interval argument has different syntax**                                            | `Interval '1 day'`                                                                        | `Interval '1' day`                                                                                                                                                                                                                                                                                          |
| **Generate_series () is now sequence ()**                                             | `explode(sequence(to_date('2022-01-01'), to_date('2022-02-01'), interval 1 day))`         | [`unnest(sequence(date('2022-01-01'), date('2022-02-01'), interval '7' day))`](https://dune.com/queries/1764158?d=11)   Has a 10000 values limit, and must go in the FROM statement not the SELECT.                                                                                                         |
| **Handling decimals for prices.usd**                                                  | Replaced by `prices.tokens decimals`                                                      | Replaced by `tokens_[blockchain].erc20.decimals`                                                                                                                                                                                                                                                            |
| **Define NULL array**                                                                 | `CAST(NULL AS ARRAY<int>))`                                                               | `CAST(NULL AS ARRAY<int>))`                                                                                                                                                                                                                                                                                 |
| **encoding strings to hex**                                                           | `hex(string)`                                                                             | `hex(string)`  *available soon                                                                                                                                                                                                                                                                              |
| **Get json object differences**                                                       | `get_json_object(get_json_object(takerOutputUpdate,'\(.deltaWei'),'\).value')'0x'`        | `json_query(json_query(takerOutputUpdate, 'lax $.deltaWei' omit quotes), 'lax $.value')`                                                                                                                                                                                                                    |
| **Group by an alias**                                                                 | Same as PostgreSQL                                                                        | `GROUP BY date_trunc('hour',evt_block_time)`Or: `GROUP BY 1, 2`                                                                                                                                                                                                                                             |
| **Explicit date/time casting**                                                        | `cast('2021-08-08 17:00' as timestamp)`                                                   | `cast('2021-08-08 17:00' as timestamp)`  Or, `timestamp '2021-08-08 17:00'`  There are [many helper functions for casting to date/time types](https://trino.io/docs/current/functions/datetime.html?highlight=date), such as `date(‘2022-01-01’)`                                                           |
| **Checking if an item exists in an array**                                            | `array_contains(array, value)`                                                            | [`contains(array, value)` or `contains_sequence(array, array[values])`](https://trino.io/docs/current/functions/array.html#contains)                                                                                                                                                                        |
| **Explode**                                                                           | `SELECT explode(array) FROM table`                                                        | `SELECT vals.val FROM table1, unnest(arrayFromTable1) as vals(val)`  you have to use `unnest` with a `cross join`, as described in this [blog post](https://theleftjoin.com/how-to-explode-arrays-with-presto/).                                                                                            |
| **Median**                                                                            | `PERCENTILE_CONT(0.5) WITHIN GROUP(ORDER BY x)`                                           | `approx_percentile(x, 0.5)`                                                                                                                                                                                                                                                                                 |
| **Using “is True/False”**                                                             | `X is true`                                                                               | `X = true`                                                                                                                                                                                                                                                                                                  |
| **String Data Type**                                                                  | `string`                                                                                  | `varchar`                                                                                                                                                                                                                                                                                                   |
| **Casting as Strings**                                                                | `cast([xxx] as string)`                                                                   | `cast([xxx] as varchar)`                                                                                                                                                                                                                                                                                    |
| **`left()` is no longer a method available for returning substrings**                 | `left([string],[length])`                                                                 | `substr([string], [start], [length])`    [Returns varchar; Positions start with 1, so use `1` for length if you want to replicate left() functionality](https://trino.io/docs/current/functions/string.html?highlight=substr#substring) `left(somestring, somenumber) -> substr(somestring, 0, somenumber)` |
| **Aggregate Functions**                                                               | `array_agg(col)` or `collect_list(col)`, `collect_set(col)` or `array_agg(distinct(col))` | `array_agg(col)`, `array_agg(distinct(col))`                                                                                                                                                                                                                                                                |
| **user generated views**                                                              | none                                                                                      | each query is a view, like [query_1747157](https://dune.com/queries/1747157)                                                                                                                                                                                                                                |
| **event logs topic indexing**                                                         | topic 1,2,3,4                                                                             | topic 0,1,2,3                                                                                                                                                                                                                                                                                               |

